---
- name: Prepare
  hosts: all
  vars:
    inventory_dir: "{{ lookup('env', 'MOLECULE_SCENARIO_DIRECTORY') }}/../../environments/vm"

  pre_tasks:
    - name: Read vars from secrets file
      include_vars: "../../environments/template/secrets/skeleton.yml"
    - name: Read vars from group_vars file
      include_vars: "../../environments/template/group_vars/template.yml"

    - name: "Set some facts"
      set_fact:
        base_domain: molecule.openconext.org
        haproxy_backend_tls: true
        use_selfsigned_certs: True
        mongo_primary: true

    - name: Install packages
      yum:
        name:
          - python2-pip
          - unzip
          - crontabs
        state: "installed"
      register: prepare_packages_installed
      until: prepare_packages_installed is succeeded

    - name: Install python crypto module
      pip:
        name: "cryptography"
        state: "latest"
      register: prepare_pip_packages_installed
      until: prepare_pip_packages_installed is succeeded

    - name: create CA key
      openssl_privatekey:
        path: /root/CA_key.key

    - name: create the CA CSR
      openssl_csr:
        path: /root/CA.csr
        privatekey_path: /root/CA_key.key
        common_name: "my-ca"

    - name: sign the CA CSR
      openssl_certificate:
        path: /root/CA.crt
        csr_path: /root/CA.csr
        privatekey_path: /root/CA_key.key
        provider: selfsigned

    - name: create host key
      openssl_privatekey:
        path: /root/example_com_host_key.key

    - name: create the CSR for the http server
      openssl_csr:
        path: /root/example_com.csr
        privatekey_path: /root/example_com_host_key.key
        common_name: "{{ base_domain }}"
        subject_alt_name: 'DNS:{{ inventory_hostname }}'

    - name: sign the CSR for the http server
      openssl_certificate:
        path: /root/example_com.crt
        csr_path: /root/example_com.csr
        provider: ownca
        ownca_path: /root/CA.crt
        ownca_privatekey_path: /root/CA_key.key

    - name: "Fetch files"
      fetch:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        flat: true
      with_items:
        - src: /root/example_com.crt
          dest: "{{ inventory_dir }}/files/certs/backend.{{ base_domain }}.pem"
        - src: /root/example_com_host_key.key
          dest: "{{ inventory_dir }}/files/certs/backend.{{ base_domain }}.key"
        - src: /root/CA.crt
          dest: "{{ inventory_dir }}/files/certs/backend.{{ base_domain }}_ca.pem"

  roles:
    - role: selfsigned_certs

- name: Prepare
  hosts: all

  vars:
    inventory_dir: "{{ lookup('env', 'MOLECULE_SCENARIO_DIRECTORY') }}/../../environments/vm"

  pre_tasks:
    - name: Read vars from secrets file
      include_vars: "../../environments/template/secrets/skeleton.yml"
    - name: Read vars from group_vars file
      include_vars: "../../environments/template/group_vars/template.yml"

    - name: "Fetch files"
      fetch:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        flat: true
      with_items:
        - src: /etc/pki/tls/certs/star.molecule.openconext.org.pem
          dest: "{{ inventory_dir }}/files/certs/star.molecule.openconext.org.pem"
        - src: /etc/pki/tls/private/star.molecule.openconext.org.key
          dest: "{{ inventory_dir }}/files/certs/star.molecule.openconext.org.key"

    - name: "Override some defaults"
      set_fact:
        hosts_ip_address: "{{ ansible_all_ipv4_addresses[0] }}"
        base_domain: molecule.openconext.org
        php_servers:
          - { ip: "127.0.0.1", label: "php"}
        java_servers:
          - { ip: "127.0.0.1", label: "java"}
        engine_trusted_proxy_ips:
          - "{{ ansible_all_ipv4_addresses[0] }}"
        haproxy_backend_tls: true
        backend_tls_key: "{{lookup('file', inventory_dir + '/files/certs/backend.molecule.openconext.org.key') }}"
        haproxy_sni_ip:
          ipv4: "{{ ansible_all_ipv4_addresses[0] }}"
          ipv6:  "::1"
          certs:
            - name: star
              key_content: "{{lookup('file', inventory_dir + '/files/certs/star.molecule.openconext.org.key') }}"
              crt_name: star.{{ base_domain }}.pem
        haproxy_sni_ip_restricted:
          ipv4: 127.0.0.2
          ipv6: "::1"
          certs:
            - name: star
              key_content: "{{lookup('file', inventory_dir + '/files/certs/star.molecule.openconext.org.key') }}"
              crt_name: star.{{ base_domain }}.pem


  roles:
    - role: haproxy
    - role: httpd
    - role: mysql
    - role: mongo
    - role: php
    - role: openconext-common
    - role: engineblock
