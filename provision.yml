---
- hosts: all
  gather_facts: no
  tasks:
  - name: Read vars from secrets file
    include_vars: "{{ secrets_file }}"
    no_log: true
    tags:
     - always

- hosts: loadbalancer:loadbalancer-vm:php-apps:java-apps:storage:oidc:dbcluster:sysloghost:elk:lifecycle
  gather_facts: yes
  become: true
  roles:
    - { role: common,       tags: ['common'] }
    - { role: rsyslog,      tags: ['rsyslog'] }
    - { role: iptables, when: iptables_enable | bool,  tags: ['iptables'] }

- hosts: selfsigned_certs
  gather_facts: no
  become: true
  roles:
    - { role: selfsigned_certs, tags: ['selfsigned_certs'] } 

- hosts: php-apps-vm
  become: true
  roles:
    - { role: hosts,     tags: ['hosts'] }
    - { role: httpd,     tags: ['httpd'] }
    - { role: welcome,   tags: ['welcome'] }

- hosts: loadbalancer-vm
  gather_facts: true
  become: true
  roles:
    - { role: haproxy, tags: ['lb'] }

- hosts: loadbalancer_ha
  gather_facts: true
  become: true
  roles:
    - { role: keepalived, tags: ['keepalived'] }
    - { role: bind, tags: ['bind'] }

- hosts: loadbalancer
  gather_facts: true
  become: true
  roles:
    - { role: haproxy, tags: ['lb'] }

- hosts: php-apps:java-apps:oidc:lifecycle
  gather_facts: no
  become: true
  roles:
    - { role: httpd,     tags: ['httpd'] }

- hosts: storage
  gather_facts: no
  become: true
  roles:
    - { role: mysql, tags: ['mysql'] }

- hosts: dbcluster
  gather_facts: yes
  become: true
  roles:
    - { role: galera, tags: ['galera'] }

- hosts: dbcluster_nodes
  gather_facts: yes
  become: true
  roles:
    - { role: keepalived, tags: ['keepalived'] }

- hosts: galera_provision_host
  roles:
    - { role: galera_create_users, tags: ['galera', 'galera_create_users'] }

- hosts: mongo_servers
  gather_facts: yes
  become: true
  roles:
    - { role: mongo, tags: ['mongo'] }

- hosts: php-apps
  gather_facts: no
  become: true
  roles:
    - { role: php,               tags: ['php'     ] }
    - { role: static,            tags: ['static'  ] }
    - { role: metadata,          tags: ['static'  ] }
    - { role: openconext-common, tags: ['eb','profile'] }
    - { role: engineblock,       tags: ['eb'      ] }
    - { role: profile,           tags: ['profile' ] }
  handlers:
    - include: roles/httpd/handlers/main.yml

- hosts: lifecycle
  gather_facts: no
  become: true
  roles:
    - { role: php,               tags: ['php'     ] }
    - { role: openconext-common, tags: ['lifecycle' ] }
    - { role: lifecycle,         tags: ['lifecycle' ] }
  handlers:
    - include: roles/httpd/handlers/main.yml

- hosts: java-apps-common
  gather_facts: true
  become: true
  roles:
    - { role: java,             tags: ['java' ] }
    - { role: shibboleth,       tags: ['shib'   ] }
  handlers:
    - include: roles/httpd/handlers/main.yml

# run -t springboot -e springboot_service_to_deploy=manage,voot to only install
# the manage and voot app. Both GUI as servers will be installed.
- hosts: java-apps
  become: true
  roles:
    - { role: springboot,       tags: ['springboot'] }
  handlers:
    - include: roles/httpd/handlers/main.yml

- hosts: oidc
  gather_facts: true
  become: true
  roles:
    - { role: tomcat,           tags: ['tomcat' ] }
    - { role: oidc,            tags: ['oidc' ] }
  handlers:
    - include: roles/httpd/handlers/main.yml
    - include: roles/tomcat/handlers/main.yml

- hosts: elk
  gather_facts: true
  become: true
  roles:
    - { role: elk,        tags: ['elk' ] }

- hosts: stats
  gather_facts: true
  become: true
  roles:
    - { role: stats,      tags: ['stats' ] }
    - { role: influxdb,   tags: ['influxdb' ] }
  handlers:
    - include: roles/httpd/handlers/main.yml

- import_playbook: "{{ environment_dir }}/playbook.yml"
