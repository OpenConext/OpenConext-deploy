---
- name: Read secrets
  hosts: all
  become: true
  tasks:
    - name: Read vars from secrets file
      ansible.builtin.include_vars: "{{ inventory_dir }}/secrets/secrets.yml"
      no_log: true
      tags:
        - always

- name: Install and configure mariadb
  hosts: mysql_standalone
  serial: 1
  gather_facts: true
  become: true
  roles:
    - role: mysql
      tags: ['core', 'db_mysql', 'mysql']

- name: Install and configure galera
  hosts: dbcluster
  serial: 1 # galera does not like it when we simultaneously restart mysql service on all nodes
  gather_facts: true
  become: true
  roles:
    - role: galera
      tags: ['core', 'db_mysql', 'galera']

- name: Install and configure galera full nodes
  hosts: dbcluster_nodes
  serial: 1 # galera does not like it when we simultaneously restart mysql service on all nodes
  gather_facts: true
  become: true
  roles:
    - role: galera_create_users
      tags: ['core', 'db_mysql', 'galera', 'galera_create_users']
    - role: keepalived
      tags: ['core', 'db_mysql', 'keepalived']

# todo: rename and reconfigure groups
# this means also changing group vars
# mysql - mysql_standalone roles: mysql
#       - galera_arbiter roles: galera
#       - galera_full roles: mysql galera keepalived
