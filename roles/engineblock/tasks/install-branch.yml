---
- name: Check if target dir exists
  stat:
    path: "{{ engine_release_dir }}"
  register: eb_dir

- name: Checkout engine-block branch
  git:
    repo: https://github.com/OpenConext/OpenConext-engineblock.git
    dest: "{{ engine_branch_dir }}"
    version: "{{ engine_branch }}"
    force: yes
  register: eb_gitclone

- name: Get Composer installer signature.
  uri:
    url: https://composer.github.io/installer.sig
    return_content: true
  register: composer_installer_signature

- name: Download Composer installer
  get_url:
    url: https://getcomposer.org/installer
    dest: /tmp/composer-installer.php
    mode: 0755
    checksum: "sha384:{{ composer_installer_signature.content }}"

- name: Run Composer installer
  command: >
    php72 composer-installer.php
    chdir=/tmp

- name: Move Composer into globally-accessible location.
  command: >
    mv /tmp/composer.phar {{ composer_path }}
    creates={{ composer_path }}

- name: Add Nodesource repositories for Node.js
  yum:
    name: "https://rpm.nodesource.com/pub_12.x/el/{{ ansible_distribution_major_version }}/{{ ansible_architecture }}/nodesource-release-el{{ ansible_distribution_major_version }}-1.noarch.rpm"
    state: present

- name: Ensure Node.js and npm are installed
  yum:
    name: "nodejs-12*"
    state: present
    enablerepo: nodesource

- name: Make release
  command: "./bin/makeRelease.sh {{ engine_branch }}"
  environment:
    HOME: "{{ openconext_builds_dir }}"
  args:
    chdir: "{{ engine_branch_dir }}"
  when:
    - eb_gitclone.changed or not eb_dir.stat.exists
  register: make_release_out

- debug:
    var: make_release_out
    verbosity: 2

- name: Unpack current version
  unarchive:
    src: "{{ openconext_builds_dir }}/Releases/OpenConext-engineblock-{{ engine_branch | replace('/', '_') }}.tar.gz"
    dest: "{{ openconext_releases_dir }}"
    copy: no
  when:
    - eb_gitclone.changed or not eb_dir.stat.exists

- name: Activate new EngineBlock branch
  file:
    src: "{{ openconext_releases_dir }}/OpenConext-engineblock-{{ engine_branch | replace('/', '_') }}"
    dest: "{{ engine_current_release_symlink }}"
    state: link
  notify:
    - "restart httpd"
    - "restart php72-fpm"
