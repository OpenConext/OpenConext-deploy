#!/bin/bash
# Generate a .htpasswd file for HTTP Basic Authentication
# Usage: {{ s3_admin_user | default('admin') }} {{ s3_admin_password | default('password') }}

USERNAME="$1"
PASSWORD="$2"
OUTPUT_FILE="{{ s3_config_dir }}/.htpasswd"

# Check if htpasswd utility is available
if command -v htpasswd >/dev/null 2>&1; then
    htpasswd -bc "$OUTPUT_FILE" "$USERNAME" "$PASSWORD"
else
    # Fallback to using python if htpasswd is not available
    python3 -c "import crypt,getpass,os; print('$USERNAME:'+crypt.crypt('$PASSWORD', crypt.mksalt(crypt.METHOD_SHA512)))" > "$OUTPUT_FILE"
fi

# Set proper permissions
chmod 600 "$OUTPUT_FILE"

echo ".htpasswd file created successfully at $OUTPUT_FILE"
