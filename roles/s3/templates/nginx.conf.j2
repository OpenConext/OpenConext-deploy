server {
    listen 80;
    server_name {{ s3_domain_name }};

    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Set the max body size for uploads (adjust as needed)
    client_max_body_size {{ s3_max_body_size | default('500M') }};

    # Proxy settings
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_connect_timeout 300;
    proxy_send_timeout 300;
    proxy_read_timeout 300;
    send_timeout 300;

    # Main route to S3 API endpoint
    location / {
        proxy_pass http://s3:8333;
        proxy_buffering off;
    }

    # Admin UI for Master
    location /master/ {
        auth_basic "Restricted Access";
        auth_basic_user_file /etc/nginx/.htpasswd;
        proxy_pass http://master1:9333/;
    }

    # Admin UI for Filer
    location /filer/ {
        auth_basic "Restricted Access";
        auth_basic_user_file /etc/nginx/.htpasswd;
        proxy_pass http://filer1:8888/;
    }

    {% for i in range(1, s3_volume_count + 1) %}
    # Admin UI for Volume {{ i }}
    location /volume{{ i }}/ {
        auth_basic "Restricted Access";
        auth_basic_user_file /etc/nginx/.htpasswd;
        proxy_pass http://volume{{ i }}:8080/;
    }
    {% endfor %}

    # Management API
    location /api/ {
        auth_basic "Restricted Access";
        auth_basic_user_file /etc/nginx/.htpasswd;
        proxy_pass http://api:8080/;
    }

    # Basic server status
    location /status {
        return 200 "Server is up and running";
    }
}
