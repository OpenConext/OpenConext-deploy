filter {

  # Parse output from stepup symfony apps. These apps use the "surfnet_stepup.monolog.json_formatter" to log a
  # structured message:
  # {
  #   "channel":"php",
  #   "level":"CRITICAL",
  #   "message":"Uncaught Exception: An exception occured in driver: SQLSTATE[HY000] [2002] No route to host",
  #   "context":
  #     "sari":"_i5qZ9yk+rBiYL62MTIGvhfLRdkVds+pQgmrNl9Wx"
  #   },
  #   "extra":{
  #     "server":"gateway.stepup.example.com",
  #     "application":"stepup-gateway",
  #     "request_id":"f666ebff508cccc66f5e7d0fefa7e71a"
  #     "art":"1234"
  #   }
  # }

  if [prog] == "stepup-gateway" or [prog] == "stepup-selfservice" or [prog] == "stepup-middleware" or [prog] == "stepup-ra" {

    # Parse JSON into stepup_json
    json {
      source => "message"
      target => "json"
    }

    if "_jsonparsefailure" not in [tags] {

      # stepup_request_id: A random ID generated by stepup applications for correlating API calls belonging
      #                    to the same client HTTP request, unrelated to SAML RequestID
      #                    Used in X-Stepup-Request-Id HTTP header
      #                    See: https://github.com/SURFnet/Stepup-bundle/blob/develop/src/Request/RandomRequestIdGenerator.php
      #                         https://github.com/SURFnet/Stepup-bundle/blob/develop/src/EventListener/RequestIdRequestResponseListener.php
      #
      # stepup_sari: The SAML Request ID from the SAML AuthenticationRequest from the SP.
      #
      # stepup_art:  The four digit error for display in the user interface when an exception occurs
      #              See: https://github.com/SURFnet/Stepup-bundle/blob/develop/src/Exception/Art.php

      mutate {
        replace => {
          "message" => "%{[json][message]}"
          "severity" => "%{[json][level]}"
          "stepup_request_id" => "%{[json][extra][request_id]}"
          "stepup_sari" => "%{[json][context][sari]}"
          "stepup_art" => "%{[json][extra][art]}"
        }
      }

      mutate {
        remove_field => "json"
      }

    }

  }

}