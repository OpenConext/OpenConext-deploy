---
- name: Create the repository for mongodb
  when: ansible_os_family == 'RedHat'
  ansible.builtin.template:
    src: "mongo.repo.j2"
    dest: "/etc/yum.repos.d/mongo.repo"
    owner: root
    mode: "0640"

- name: Install the mongodb package and some helper packages
  when: ansible_os_family == 'RedHat'
  ansible.builtin.yum:
    name:
      - mongodb-org
      - pip
    state: present

- name: Install pymongo
  ansible.builtin.pip:
    name: pymongo

- name: Install kernel settings script
  ansible.builtin.copy:
    src: "mongo_kernel_settings.sh"
    dest: "/usr/local/sbin/mongo_kernel_settings.sh"
    mode: "0700"
    owner: root
    group: root
  register: mongo_kernel_settings

- name: Set kernel parameters
  ansible.builtin.command: /usr/local/sbin/mongo_kernel_settings.sh
  when:
    - mongo_kernel_settings.changed

- name: Add mongo kernel settings script to rc.local
  ansible.builtin.lineinfile:
    dest: "/etc/rc.local"
    state: present
    line: "/usr/local/sbin/mongo_kernel_settings.sh"

- name: Make rc.local executable
  ansible.builtin.file:
    dest: "/etc/rc.d/rc.local"
    mode: "0744"
    owner: root
    group: root

- name: Set sysctl vm.max_map_count
  ansible.posix.sysctl:
    name: vm.max_map_count
    value: 128000
    state: present

- name: Enable and start mongod for the first time
  ansible.builtin.service:
    name: mongod.service
    enabled: true
    state: started

- name: Check if mongodb authentication is activated
  ansible.builtin.shell:
    cmd: "mongosh 'mongodb://127.0.0.1:{{ mongo_port }}/admin' --eval 'db.runCommand({ usersInfo: 1 })'"
  register: mongo_authentication_enabled
  changed_when: false
  ignore_errors: true
  check_mode: false # This can safely run in check mode because it is not changing anything

- name: Debug mongodb authentication check
  ansible.builtin.debug:
    msg: "{{ mongo_authentication_enabled.stdout }}"
    verbosity: 2

# first run add admin user without logging in
- name: Add the admin user
  community.mongodb.mongodb_user:
    login_database: admin
    database: admin
    name: admin
    password: "{{ mongo_admin_password }}"
    login_port: "{{ mongo_port }}"
    roles: root
    state: present
  no_log: true
  run_once: true
  when: mongo_authentication_enabled.rc == 0

- name: Install mongodb.conf file
  ansible.builtin.template:
    src: "mongod.conf.j2"
    dest: "/etc/mongod.conf"
    owner: root
    group: root
    mode: "0644"
    backup: true
  notify: Restart mongod

# restart mongo right away with authentication enabled
- name: Flush handlers
  ansible.builtin.meta: flush_handlers
