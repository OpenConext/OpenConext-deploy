---
- name: Install latest version of nss
  yum:
    name: nss
    state: latest
  register: oidc_package_nss_installed
  until: oidc_package_nss_installed is succeeded

- name: copy locale languages files
  copy:
    src: resources
    dest: "{{ tomcat.install_dir }}/{{ tomcat.properties_dir }}/oidc"
    owner: "tomcat"
    group: "tomcat"
    mode: 0740
  register: oidc_language_files

- name: add language files to war
  shell: jar -uvf {{ tomcat_install_dir }}/wars/{{ deploy_name }}.war ./resources/ chdir={{ tomcat.install_dir }}/{{ tomcat.properties_dir }}/oidc
  when:
    - new_deployment is defined

- name: change permissions to war
  file:
    path: "{{ tomcat_install_dir }}/wars/{{ deploy_name }}.war"
    owner: "tomcat"
    group: "tomcat"
    mode: 0644

- name: copy oidc configuration
  template:
    src: "{{ item.src }}.j2"
    dest: "{{ tomcat.install_dir }}/{{ tomcat.properties_dir }}/{{ item.src }}"
    group: "{{ item.owner | default(omit) }}"
    owner: "{{ item.group | default(omit) }}"
  with_items:
    - src: application.oidc.properties
    - src: clientsAndResources.yml
    - src: oidc.keystore.jwks.json
    - src: oidc-logback.xml
      owner: tomcat
      group: tomcat
  tags:
    - oidc
  notify:
    - "restart tomcat"

- meta: flush_handlers

- name: copy virtual host config
  template:
    src: oidc.conf.j2
    dest: /etc/httpd/conf.d/oidc.conf
  notify:
    - "reload httpd"
