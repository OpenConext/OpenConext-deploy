# Github action to build, run and test a Docker image.

name: CI
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:

  Build-and-Push-Docker-Image:
    runs-on: ubuntu-latest
    name: Docker Build, Tag, Push

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Set up Python 3.8
      uses: actions/setup-python@v2
      with:
        python-version: 3.8

    - name: Installing dependencies
      run: sudo apt-get -y install python3 python3-pip python3-yaml python3-dev

    - name: Docker build
      run: sudo /bin/bash ./tests/travis-build.sh

    - name: Docker login
      run: docker login docker.pkg.github.com -u ${{github.actor}} -p ${{secrets.GITHUB_TOKEN}}

    - name: Push Docker image
      run: |
        DOCKER_ANSIBLE_TEST_COMMIT=$(docker commit ansible-test)
        DOCKER_ANSIBLE_TEST_IMAGE_ID=$(echo ${DOCKER_ANSIBLE_TEST_COMMIT} | awk -F ':' '{print $2}' | cut -c1-12)
        docker tag ${DOCKER_ANSIBLE_TEST_IMAGE_ID} docker.pkg.github.com/OpenConext/OpenConext-deploy/OpenConext-core
        docker push docker.pkg.github.com/OpenConext/OpenConext-deploy/OpenConext-core
