# Github action to run Molecule for "base"

name: loadbalancer
on:
  push:
    paths:
      - 'roles/haproxy/**'
      - 'roles/keepalived/**'
      - 'roles/bind/**'
      - 'molecule/loadbalancer/**'
      - 'roles/selfsigned_certs/**'
      - '.github/workflows/molecule-loadbalancer.yml'
  pull_request:
    paths:
      - 'roles/haproxy/**'
      - 'roles/keepalived/**'
      - 'roles/bind/**'
      - 'molecule/loadbalancer/**'
      - 'roles/selfsigned_certs/**'
      - '.github/workflows/molecule-loadbalancer.yml'

jobs:
  build:
    runs-on: "ubuntu-24.04"
    steps:
      - uses: "actions/checkout@v2"

      - name: "Set up Python 3.12"
        uses: "actions/setup-python@v4"
        with:
          python-version: "3.12"

      - name: "Installing dependencies"
        run: |
          pip install jinja2 ansible molecule molecule-docker pytest-testinfra pytest setuptools

      - name: "Run role tests"
        env:
          ANSIBLE_VERBOSITY: 3
        run: |
          molecule test -s loadbalancer

      - name: debug
        run: |
          cat /home/runner/.cache/molecule/OpenConext-deploy/loadbalancer/ansible.cfg

      - name: debug
        run: |
          docker run -ti penconext-rocky9-loadbalancer ls -lad /tmp/
