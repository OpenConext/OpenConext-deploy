# Github action to build, run and test a Docker image.

name: build-docker
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:

  Build-Docker-Image:
    runs-on: ubuntu-latest
    name: Build Docker Image

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Set up Python 3.8
      uses: actions/setup-python@v2
      with:
        python-version: 3.8

    - name: Installing dependencies
      run: |
        apt-get -y update
        apt-get -y install python3 python3-pip python3-yaml python3-dev

    - name: Installing pip dependencies
      run: pip install jinja2

    - name: Docker build
      run: docker build --rm -t surfnet/centos7-openconext -f tests/Dockerfile.centos-7 .

    - name: Provision Docker container
      run: /bin/bash ./tests/travis-build.sh

    - name: Docker login
      run: docker login docker.pkg.github.com -u ${{github.actor}} -p ${{secrets.GITHUB_TOKEN}}
    
    - name: Docker commit and push
      run: |
        DOCKER_ANSIBLE_TEST_COMMIT=$(docker commit ansible-test)
        DOCKER_ANSIBLE_TEST_IMAGE_ID=$(echo ${DOCKER_ANSIBLE_TEST_COMMIT} | awk -F ':' '{print $2}' | cut -c1-12)
        docker tag ${DOCKER_ANSIBLE_TEST_IMAGE_ID} OpenConext/OpenConext-deploy/OpenConext-core
        docker push docker.pkg.github.com/OpenConext/OpenConext-deploy/OpenConext-core
